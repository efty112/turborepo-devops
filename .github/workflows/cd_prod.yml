name: Deploy to Production

on:
    push: 
        branches: [production]

jobs:
    redeploy_everything:
        name: Deploy everything to the production cluster
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v2

            - name: SSH into the EC2
              uses: appleboy/ssh-action@v1.2.1
              with:
                host: 13.233.119.37
                username: ubuntu
                key: ${{ secrets.KEY }}
                port: 22
                passphrase: ${{ secrets.PASSPHRASE }}
                script: |
                  cd /home/ubuntu/${{ github.event.repository.name }}/
                  git pull
                  sudo npm install -g pnpm
                  pnpm -v
                  pnpm install && pnpm run build
                  pm2 restart fe-server && pm2 restart http-server && pm2 restart ws-server 